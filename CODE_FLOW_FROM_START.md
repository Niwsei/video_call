# üöÄ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô App

## ‡∏™‡∏≤‡∏£‡∏ö‡∏±‡∏ç
1. [STEP 1: ‡πÄ‡∏õ‡∏¥‡∏î App - main() function](#step-1-‡πÄ‡∏õ‡∏¥‡∏î-app---main-function)
2. [STEP 2: Initialize Firebase](#step-2-initialize-firebase)
3. [STEP 3: Register Background Handler](#step-3-register-background-handler)
4. [STEP 4: Request Notification Permission](#step-4-request-notification-permission)
5. [STEP 5: ‡πÅ‡∏™‡∏î‡∏á LoginPage](#step-5-‡πÅ‡∏™‡∏î‡∏á-loginpage)
6. [STEP 6: User ‡∏Å‡∏£‡∏≠‡∏Å Login ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend](#step-6-user-‡∏Å‡∏£‡∏≠‡∏Å-login--‡πÄ‡∏£‡∏µ‡∏¢‡∏Å-backend)
7. [STEP 7: Backend Generate Token](#step-7-backend-generate-token)
8. [STEP 8: Initialize StreamVideo Client](#step-8-initialize-streamvideo-client)
9. [STEP 9: Register FCM Token ‡∏Å‡∏±‡∏ö Stream](#step-9-register-fcm-token-‡∏Å‡∏±‡∏ö-stream)
10. [STEP 10: Navigate ‡πÑ‡∏õ HomePage](#step-10-navigate-‡πÑ‡∏õ-homepage)
11. [STEP 11: Listen for Incoming Calls](#step-11-listen-for-incoming-calls)
12. [STEP 12: User A ‡πÇ‡∏ó‡∏£‡∏´‡∏≤ User B](#step-12-user-a-‡πÇ‡∏ó‡∏£‡∏´‡∏≤-user-b)
13. [STEP 13: Stream ‡∏™‡πà‡∏á Push Notification](#step-13-stream-‡∏™‡πà‡∏á-push-notification)
14. [STEP 14: User B ‡∏£‡∏±‡∏ö Notification](#step-14-user-b-‡∏£‡∏±‡∏ö-notification)
15. [STEP 15: User B ‡∏Å‡∏î Accept](#step-15-user-b-‡∏Å‡∏î-accept)
16. [STEP 16: WebRTC Connection Setup](#step-16-webrtc-connection-setup)
17. [STEP 17: Active Call - Video/Audio Streaming](#step-17-active-call---videoaudio-streaming)
18. [STEP 18: End Call](#step-18-end-call)

---

# STEP 1: ‡πÄ‡∏õ‡∏¥‡∏î App - main() function

## ‡πÑ‡∏ü‡∏•‡πå: `lib/main.dart`

```dart
void main() async {
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:
- **`void main()`**: Entry point ‡∏Ç‡∏≠‡∏á Flutter app
  - Dart compiler ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏£‡∏Å
  - ‡∏ó‡∏∏‡∏Å Flutter app ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ `main()` function

- **`async`**: ‡∏ó‡∏≥‡πÉ‡∏´‡πâ function ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô asynchronous
  - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ `await` ‡πÑ‡∏î‡πâ
  - ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á initialize Firebase (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô async operation)

---

```dart
  WidgetsFlutterBinding.ensureInitialized();
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:
- **‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
  - Initialize Flutter engine
  - Setup communication channel ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Flutter framework ‡∏Å‡∏±‡∏ö native platform (Android/iOS)

- **‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å:**
  - ‡∏õ‡∏Å‡∏ï‡∏¥ `runApp()` ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  - ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ native plugins **‡∏Å‡πà‡∏≠‡∏ô** `runApp()` (‡πÄ‡∏ä‡πà‡∏ô Firebase) ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏≠‡∏á
  - ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error: "ServicesBinding.defaultBinaryMessenger was accessed before the binding was initialized"

- **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å:**
  - ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å `await Firebase.initializeApp()` ‡∏Å‡πà‡∏≠‡∏ô `runApp()`
  - ‡πÉ‡∏ä‡πâ `SharedPreferences`, `PathProvider`, ‡∏´‡∏£‡∏∑‡∏≠ native plugin ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏Å‡πà‡∏≠‡∏ô `runApp()`

---

# STEP 2: Initialize Firebase

```dart
  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`Firebase.initializeApp()`:**
- **‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
  1. ‡∏≠‡πà‡∏≤‡∏ô Firebase configuration (API keys, project IDs)
  2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase services
  3. Setup Firebase SDK

- **`options: DefaultFirebaseOptions.currentPlatform`:**
  - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Firebase config ‡∏ï‡∏≤‡∏° platform ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô
  - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏à‡∏≤‡∏Å `lib/firebase_options.dart`

**`DefaultFirebaseOptions.currentPlatform` ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á:**

```dart
static FirebaseOptions get currentPlatform {
  if (kIsWeb) {
    return web;  // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏ö‡∏ô web browser
  }
  switch (defaultTargetPlatform) {
    case TargetPlatform.android:
      return android;  // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏ö‡∏ô Android
    case TargetPlatform.iOS:
      return ios;  // ‡∏ñ‡πâ‡∏≤‡∏£‡∏±‡∏ô‡∏ö‡∏ô iOS
    default:
      throw UnsupportedError('Unsupported platform');
  }
}
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á `FirebaseOptions.android`:**
```dart
static const FirebaseOptions android = FirebaseOptions(
  apiKey: 'AIzaSyC...',               // ‡∏à‡∏≤‡∏Å google-services.json
  appId: '1:564591146605:android:...', // App ID
  messagingSenderId: '564591146605',   // FCM Sender ID
  projectId: 'notificationforlailaolab', // Firebase Project ID
  storageBucket: 'notificationforlailaolab.appspot.com',
);
```

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô:**
1. Firebase SDK ‡∏≠‡πà‡∏≤‡∏ô config
2. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase Backend
3. Verify project credentials
4. Setup Firebase services:
   - Firebase Messaging (FCM)
   - Firebase Analytics (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î)
   - Firebase Crashlytics (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î)

**Output:**
- Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
- `FirebaseMessaging.instance` ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏î‡πâ

---

# STEP 3: Register Background Handler

```dart
  FirebaseMessaging.onBackgroundMessage(firebaseMessagingBackgroundHandler);
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`FirebaseMessaging.onBackgroundMessage()`:**
- **‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
  - Register function ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ push notification ‡∏°‡∏≤‡∏ï‡∏≠‡∏ô‡πÅ‡∏≠‡∏õ‡∏≠‡∏¢‡∏π‡πà background/terminated

- **`firebaseMessagingBackgroundHandler`:**
  - Function ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ‡πÉ‡∏ô `lib/firebase_background_handler.dart`
  - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô **top-level function** (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà method ‡πÉ‡∏ô class)
  - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ `@pragma('vm:entry-point')`

**‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á register:**
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‚Üí notification ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà main isolate ‡πÑ‡∏î‡πâ
- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ special handler ‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡πÉ‡∏ô background isolate
- Handler ‡∏ô‡∏µ‡πâ‡∏à‡∏∞:
  1. ‡∏£‡∏±‡∏ö notification data
  2. ‡πÅ‡∏™‡∏î‡∏á CallKit/ConnectionService UI
  3. Wake up ‡πÅ‡∏≠‡∏õ (‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)

**Flow ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ notification:**

```
App State: Background/Terminated
          ‚Üì
Firebase Cloud Messaging
          ‚Üì
Native OS (Android/iOS)
          ‚Üì
Flutter Background Isolate
          ‚Üì
firebaseMessagingBackgroundHandler()
          ‚Üì
StreamVideoPushNotificationManager.onBackgroundMessage()
          ‚Üì
‡πÅ‡∏™‡∏î‡∏á CallKit/ConnectionService UI
```

---

# STEP 4: Request Notification Permission

```dart
  await FirebaseMessaging.instance.requestPermission(
    alert: true,
    badge: true,
    sound: true,
  );
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`requestPermission()`:**
- **‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
  - ‡πÅ‡∏™‡∏î‡∏á popup ‡∏Ç‡∏≠ permission ‡∏à‡∏≤‡∏Å user
  - iOS: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
  - Android 13+: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å (‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
  - Android 12-: Auto granted (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠)

**Parameters:**
- **`alert: true`**: ‡πÅ‡∏™‡∏î‡∏á notification banner
- **`badge: true`**: ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ö‡∏ô app icon
- **`sound: true`**: ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á notification

**Return:**
```dart
class NotificationSettings {
  AuthorizationStatus authorizationStatus;
  // granted, denied, provisional, notDetermined
}
```

**‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:**
```dart
final settings = await FirebaseMessaging.instance.requestPermission(...);

if (settings.authorizationStatus == AuthorizationStatus.granted) {
  print('‚úÖ User granted permission');
} else if (settings.authorizationStatus == AuthorizationStatus.denied) {
  print('‚ùå User denied permission');
}
```

**iOS Popup:**
```
"MyVideoApp" Would Like to Send You Notifications
Notifications may include alerts, sounds, and icon badges.
[Don't Allow]  [Allow]
```

**Android 13+ Popup:**
```
Allow MyVideoApp to send you notifications?
[Don't allow]  [Allow]
```

---

```dart
  runApp(const MyApp());
}
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`runApp()`:**
- **‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
  1. ‡∏™‡∏£‡πâ‡∏≤‡∏á widget tree
  2. Attach ‡πÑ‡∏õ‡∏ó‡∏µ‡πà screen
  3. ‡πÄ‡∏£‡∏¥‡πà‡∏° render UI

- **`const MyApp()`**:
  - Root widget ‡∏Ç‡∏≠‡∏á app
  - ‡πÄ‡∏õ‡πá‡∏ô `StatelessWidget` ‡∏´‡∏£‡∏∑‡∏≠ `StatefulWidget`

**‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô:**
```
runApp(MyApp)
    ‚Üì
MyApp.build()
    ‚Üì
MaterialApp(home: LoginPage())
    ‚Üì
LoginPage widget ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
```

---

# STEP 5: ‡πÅ‡∏™‡∏î‡∏á LoginPage

## ‡πÑ‡∏ü‡∏•‡πå: `lib/main.dart`

```dart
class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Video Call App',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.blue),
        useMaterial3: true,
      ),
      home: const LoginPage(),  // ‚Üê ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
    );
  }
}
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`MaterialApp`:**
- Root widget ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Material Design app
- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î:
  - **`title`**: ‡∏ä‡∏∑‡πà‡∏≠ app (‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô task switcher)
  - **`theme`**: ‡∏ò‡∏µ‡∏°‡∏Ç‡∏≠‡∏á app (‡∏™‡∏µ, font, etc.)
  - **`home`**: ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á

**`home: const LoginPage()`:**
- ‡πÅ‡∏™‡∏î‡∏á `LoginPage` ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
- `const`: compile-time constant (performance optimization)

**Output:**
- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á LoginPage
- User ‡πÄ‡∏´‡πá‡∏ô text fields ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å User ID ‡πÅ‡∏•‡∏∞ Name

---

# STEP 6: User ‡∏Å‡∏£‡∏≠‡∏Å Login ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend

## ‡πÑ‡∏ü‡∏•‡πå: `lib/pages/login_page.dart`

```dart
class _LoginPageState extends State<LoginPage> {
  final _userIdController = TextEditingController();
  final _userNameController = TextEditingController();
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`TextEditingController`:**
- ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° text field
- ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà user ‡∏û‡∏¥‡∏°‡∏û‡πå
- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢ `controller.text`

**‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ:**
```dart
// ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ controller (‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
TextField(
  onChanged: (value) {
    userId = value;  // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö state ‡πÄ‡∏≠‡∏á
  },
)

// ‡πÉ‡∏ä‡πâ controller (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
TextField(
  controller: _userIdController,
)
// ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤: _userIdController.text
```

---

### User ‡∏Å‡∏î "Login" button:

```dart
Future<void> _login() async {
  final userId = _userIdController.text.trim();
  final userName = _userNameController.text.trim();
```

**`.trim()`:**
- ‡∏ï‡∏±‡∏î whitespace ‡∏´‡∏ô‡πâ‡∏≤-‡∏´‡∏•‡∏±‡∏á
- `"  user123  "` ‚Üí `"user123"`

---

```dart
  if (userId.isEmpty || userName.isEmpty) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Please enter user ID and name')),
    );
    return;
  }
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**Validation:**
- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ user ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‚Üí ‡πÅ‡∏™‡∏î‡∏á Snackbar (popup ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)

**`ScaffoldMessenger.of(context)`:**
- ‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á Snackbar, SnackBars queue
- `of(context)` = ‡∏´‡∏≤ `ScaffoldMessenger` ‡∏à‡∏≤‡∏Å widget tree

---

```dart
  setState(() => _isLoading = true);
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`setState()`:**
- ‡∏ö‡∏≠‡∏Å Flutter ‡∏ß‡πà‡∏≤ state ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí rebuild UI
- `_isLoading = true` ‚Üí ‡πÅ‡∏™‡∏î‡∏á loading indicator ‡πÅ‡∏ó‡∏ô‡∏õ‡∏∏‡πà‡∏°

**UI ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô:**
```dart
_isLoading
    ? CircularProgressIndicator()  // ‡πÅ‡∏™‡∏î‡∏á loading
    : ElevatedButton(...)           // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°
```

---

```dart
  try {
    final response = await http.post(
      Uri.parse('http://localhost:8181/v1/api/callStreams'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({'userId': userId}),
    );
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`http.post()`:**
- ‡∏™‡πà‡∏á HTTP POST request

**Parameters:**

1. **`Uri.parse(url)`:**
   - ‡πÅ‡∏õ‡∏•‡∏á string ‡πÄ‡∏õ‡πá‡∏ô Uri object
   - `http://localhost:8181/v1/api/callStreams`

2. **`headers`:**
   ```dart
   {'Content-Type': 'application/json'}
   ```
   - ‡∏ö‡∏≠‡∏Å server ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á JSON

3. **`body`:**
   ```dart
   jsonEncode({'userId': userId})
   ```
   - ‡πÅ‡∏õ‡∏•‡∏á Map ‚Üí JSON string
   - `{'userId': 'user-123'}` ‚Üí `'{"userId":"user-123"}'`

**Request ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏õ:**
```http
POST http://localhost:8181/v1/api/callStreams
Content-Type: application/json

{"userId":"user-123"}
```

---

# STEP 7: Backend Generate Token

## ‡πÑ‡∏ü‡∏•‡πå: `backend/src/controllers/streamController.ts`

### Backend ‡∏£‡∏±‡∏ö request:

```typescript
export const generateStreamToken = (req: any, res: any) => {
  const userId = req.body?.userId;
```

**‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤:**
- `req.body` = request body ‡∏ó‡∏µ‡πà Flutter app ‡∏™‡πà‡∏á‡∏°‡∏≤
- `req.body.userId` = `"user-123"`

---

```typescript
  if (!userId) {
    return res.status(400).json({ error: 'userId is required' });
  }
```

**Validation:**
- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ userId ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí return error 400 (Bad Request)

---

```typescript
  const issuedAt = Math.floor(Date.now() / 1000);
  const expiresAt = issuedAt + TOKEN_TTL;
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á timestamp:**
```javascript
Date.now() = 1759900000000  // milliseconds
  ‚Üì / 1000
1759900000  // seconds (JWT ‡πÉ‡∏ä‡πâ seconds)
  ‚Üì + TOKEN_TTL (86400 = 24 hours)
1759986400  // expiration timestamp
```

---

```typescript
  const token = jwt.sign(
    {
      user_id: userId,
      validity_in_seconds: TOKEN_TTL,
      iat: issuedAt,
      exp: expiresAt,
    },
    STREAM_API_SECRET,
    { algorithm: 'HS256' }
  );
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á JWT Token:**

**Input:**
- **Payload:** `{ user_id: "user-123", iat: 1759900000, exp: 1759986400 }`
- **Secret:** `STREAM_API_SECRET` (‡∏à‡∏≤‡∏Å .env)
- **Algorithm:** HS256

**Process:**
```
1. Encode Header:
   {"alg":"HS256","typ":"JWT"}
   ‚Üí Base64 ‚Üí "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9"

2. Encode Payload:
   {"user_id":"user-123","iat":1759900000,"exp":1759986400}
   ‚Üí Base64 ‚Üí "eyJ1c2VyX2lkIjoidXNlci0xMjMiLCJpYXQiOjE3NTk5MDAwMDAsImV4cCI6MTc1OTk4NjQwMH0"

3. Create Signature:
   HMACSHA256(
     "eyJhbGc...JWT" + "." + "eyJ1c2V...",
     STREAM_API_SECRET
   )
   ‚Üí "nUk_CXHHmp6HICwoPyHm0Ag2jQqmcdVMPuMBmXOK0-0"

4. Combine:
   Header.Payload.Signature
```

**Output:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoidXNlci0xMjMiLCJpYXQiOjE3NTk5MDAwMDAsImV4cCI6MTc1OTk4NjQwMH0.nUk_CXHHmp6HICwoPyHm0Ag2jQqmcdVMPuMBmXOK0-0
```

---

```typescript
  return res.json({
    apiKey: STREAM_API_KEY,
    userId: userId,
    token: token,
    expiresAt: expiresAt,
  });
}
```

**‡∏™‡πà‡∏á response ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Flutter:**
```json
{
  "apiKey": "r9mn4fsbzhub",
  "userId": "user-123",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresAt": 1759986400
}
```

---

# ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà Flutter App

## ‡πÑ‡∏ü‡∏•‡πå: `lib/pages/login_page.dart`

```dart
    if (response.statusCode != 200) {
      throw Exception('Failed to get token');
    }
```

**‡πÄ‡∏ä‡πá‡∏Ñ response:**
- Status 200 = success
- ‡∏≠‡∏∑‡πà‡∏ô‡πÜ = error

---

```dart
    final data = jsonDecode(response.body);
```

**‡πÅ‡∏õ‡∏•‡∏á JSON ‚Üí Map:**
```dart
// response.body (String):
'{"apiKey":"r9mn4fsbzhub","userId":"user-123","token":"eyJ..."}'

// jsonDecode() ‚Üì

// data (Map):
{
  'apiKey': 'r9mn4fsbzhub',
  'userId': 'user-123',
  'token': 'eyJ...',
  'expiresAt': 1759986400
}
```

---

```dart
    final apiKey = data['apiKey'];
    final token = data['token'];
```

**‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Map:**
- `data['apiKey']` ‚Üí `"r9mn4fsbzhub"`
- `data['token']` ‚Üí `"eyJ..."`

---

# STEP 8: Initialize StreamVideo Client

```dart
    await StreamService.initialize(
      apiKey: apiKey,
      userId: userId,
      userName: userName,
      userToken: token,
    );
```

## ‡πÑ‡∏ü‡∏•‡πå: `lib/services/stream_service.dart`

```dart
static Future<StreamVideo> initialize({
  required String apiKey,
  required String userId,
  required String userName,
  required String userToken,
}) async {
```

**‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤:**
- `apiKey`: `"r9mn4fsbzhub"`
- `userId`: `"user-123"`
- `userName`: `"Alice"`
- `userToken`: `"eyJ..."`

---

```dart
  if (_client != null) {
    return _client!;
  }
```

**‡πÄ‡∏ä‡πá‡∏Ñ singleton:**
- ‡∏ñ‡πâ‡∏≤ init ‡πÅ‡∏•‡πâ‡∏ß ‚Üí return client ‡πÄ‡∏î‡∏¥‡∏°
- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß

---

```dart
  final user = User(id: userId, name: userName);
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á User object:**
```dart
User(
  id: 'user-123',
  name: 'Alice',
  // role, image, extraData (optional)
)
```

**User object ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
- ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô UI
- ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô call logs

---

```dart
  _client = StreamVideo(
    apiKey,
    user: user,
    userToken: userToken,
    pushNotificationManagerProvider: StreamVideoPushNotificationManager.create(
      androidPushProvider: const StreamVideoPushProvider.firebase(
        name: 'niwner_notification',
      ),
      iosPushProvider: const StreamVideoPushProvider.apn(
        name: 'niwner_notification',
      ),
    ),
  );
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á StreamVideo client:**

**Parameters:**
1. **`apiKey`**: `"r9mn4fsbzhub"` - ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô app ‡πÑ‡∏´‡∏ô
2. **`user`**: User object - ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
3. **`userToken`**: JWT token - ‡πÉ‡∏ä‡πâ authenticate

4. **`pushNotificationManagerProvider`**:
   - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ push notifications
   - Register FCM/APNs token
   - Handle incoming notifications

**`StreamVideoPushProvider.firebase(name: 'niwner_notification')`:**
- ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ Firebase FCM
- `name` ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Push Provider ‡πÉ‡∏ô Stream Dashboard

---

# STEP 9: Register FCM Token ‡∏Å‡∏±‡∏ö Stream

```dart
  await _client!.connect();
```

**`connect()` ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á:**

### 9.1 Validate Token
```
Flutter App ‚Üí Stream Backend
POST https://video.stream-io-api.com/api/v2/connect
Authorization: eyJhbGc... (JWT Token)

Stream Backend:
1. Decode JWT
2. Verify signature with STREAM_API_SECRET
3. Check expiration (exp > now)
4. Extract user_id

‡∏ñ‡πâ‡∏≤ valid ‚Üí Continue
‡∏ñ‡πâ‡∏≤ invalid ‚Üí Return error: "Token signature is invalid"
```

---

### 9.2 Open WebSocket Connection
```
Flutter App ‚Üî Stream Backend
WebSocket: wss://video.stream-io-api.com/ws

Purpose:
- Real-time events (incoming calls, call state changes)
- Bi-directional communication
- Low latency
```

---

### 9.3 Get FCM Token

```dart
// Inside StreamVideoPushNotificationManager:
final fcmToken = await FirebaseMessaging.instance.getToken();
print('FCM Token: $fcmToken');
```

**FCM Token:**
```
dFp8HxN-QkG7RzVQX-fPQW:APA91bFj3P9xKLm8Rq0S...
```
- ‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 163 characters
- Unique ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ device
- ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏∏ device ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á push notification

---

### 9.4 Register Token ‡∏Å‡∏±‡∏ö Stream

```
Flutter App ‚Üí Stream Backend
POST https://video.stream-io-api.com/api/v2/devices
Authorization: eyJhbGc...
Content-Type: application/json

{
  "id": "dFp8HxN-QkG7RzVQX-fPQW:APA91bF...",
  "push_provider": "firebase",
  "push_provider_name": "niwner_notification",
  "user_id": "user-123"
}
```

**Stream Backend ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:**
```
Database:
users {
  user_id: "user-123",
  devices: [
    {
      token: "dFp8HxN-QkG7RzVQX-fPQW:APA91bF...",
      provider: "niwner_notification",
      platform: "android",
      registered_at: "2025-02-07T10:30:00Z"
    }
  ]
}
```

**‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á register:**
- Stream ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á notification ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô
- ‡πÄ‡∏Å‡πá‡∏ö mapping: user_id ‚Üí FCM token
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡πÇ‡∏ó‡∏£‡∏´‡∏≤ user-123 ‚Üí Stream query token ‚Üí ‡∏™‡πà‡∏á push

---

### 9.5 Sync User State

```
Stream Backend ‚Üí Flutter App
Event: user.connected

{
  "type": "user.connected",
  "user": {
    "id": "user-123",
    "name": "Alice",
    "online": true
  },
  "connection_id": "abc-def-123"
}
```

---

**`connect()` ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:**
```dart
print('‚úÖ Stream Video connected');
```

**Output:**
- WebSocket connection established
- FCM token registered
- User status: online
- Ready to make/receive calls

---

# STEP 10: Navigate ‡πÑ‡∏õ HomePage

```dart
    if (mounted) {
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(builder: (_) => const HomePage()),
      );
    }
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`mounted`:**
- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ widget ‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô widget tree ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- ‡∏ñ‡πâ‡∏≤ user ‡∏Å‡∏î back ‡∏Å‡πà‡∏≠‡∏ô async operation ‡πÄ‡∏™‡∏£‡πá‡∏à ‚Üí mounted = false
- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error: "setState() called after dispose()"

**`Navigator.pushReplacement()`:**
- Replace ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (LoginPage) ‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (HomePage)
- User ‡∏Å‡∏î back ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ LoginPage
- ‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å `Navigator.push()` ‡∏ó‡∏µ‡πà stack ‡∏´‡∏ô‡πâ‡∏≤

**Flow:**
```
[LoginPage]
    ‚Üì pushReplacement
[HomePage]  ‚Üê ‡∏Å‡∏î back ‡∏à‡∏∞‡∏≠‡∏≠‡∏Å app
```

---

# STEP 11: Listen for Incoming Calls

## ‡πÑ‡∏ü‡∏•‡πå: `lib/pages/home_page.dart`

```dart
class _HomePageState extends State<HomePage> {
  @override
  void initState() {
    super.initState();
    _observeIncomingCalls();
  }
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`initState()`:**
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á widget
- ‡πÉ‡∏ä‡πâ setup listeners, controllers, etc.
- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö subscribe streams

---

```dart
  void _observeIncomingCalls() {
    StreamService.client.state.incomingCall.listen((call) {
      if (call != null && mounted) {
        print('üìû Incoming call from: ${call.state.value.createdBy?.name}');
        Navigator.push(
          context,
          MaterialPageRoute(
            builder: (_) => CallPage(call: call, isOutgoing: false),
          ),
        );
      }
    });
  }
```

### ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:

**`state.incomingCall`:**
- **Type:** `ValueStream<Call?>`
- **‡∏Ñ‡∏∑‡∏≠:** Stream ‡∏ó‡∏µ‡πà emit ‡∏Ñ‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ incoming call
- **‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà emit:**
  - ‡∏°‡∏µ incoming call ‚Üí `Call` object
  - ‡πÑ‡∏°‡πà‡∏°‡∏µ call ‚Üí `null`

**`.listen((call) { ... })`:**
- Subscribe to stream
- Callback ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà

**Flow:**
```
1. ‡∏°‡∏µ notification ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
   ‚Üì
2. Stream SDK parse message
   ‚Üì
3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Call object
   ‚Üì
4. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï incomingCall stream
   ‚Üì
5. Listener ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
   ‚Üì
6. ‡πÄ‡∏õ‡∏¥‡∏î CallPage
```

**State:**
```dart
// Before incoming call:
incomingCall.value = null

// After incoming call:
incomingCall.value = Call(
  id: '11d3e2b5-...',
  type: 'default',
  createdBy: User(id: 'user-a', name: 'Alice'),
  members: ['user-a', 'user-b'],
  status: CallStatus.ringing,
)
```

---

**‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ HomePage:**

```dart
Widget build(BuildContext context) {
  final currentUser = StreamService.client.currentUser;

  return Scaffold(
    appBar: AppBar(
      title: Text('Hello, ${currentUser.name}'),
    ),
    body: Column(
      children: [
        Text('Your ID: ${currentUser.id}'),
        TextField(
          controller: _calleeIdController,
          decoration: InputDecoration(
            labelText: 'Callee User ID',
          ),
        ),
        ElevatedButton(
          onPressed: () => _startCall(isVideoCall: true),
          child: Text('Video Call'),
        ),
      ],
    ),
  );
}
```

**User ‡πÄ‡∏´‡πá‡∏ô:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Hello, Alice                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Your ID: user-123            ‚îÇ
‚îÇ                              ‚îÇ
‚îÇ Callee User ID               ‚îÇ
‚îÇ [_________________]          ‚îÇ
‚îÇ                              ‚îÇ
‚îÇ [üé• Video Call]              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

# STEP 12: User A ‡πÇ‡∏ó‡∏£‡∏´‡∏≤ User B

## User A ‡∏Å‡∏£‡∏≠‡∏Å User B ID ‡πÅ‡∏•‡∏∞‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "Video Call"

```dart
Future<void> _startCall({required bool isVideoCall}) async {
  final calleeId = _calleeIdController.text.trim();
```

**‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤:**
- `calleeId` = `"user-b"` (‡∏ó‡∏µ‡πà user A ‡∏Å‡∏£‡∏≠‡∏Å)

---

```dart
  if (calleeId.isEmpty) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Please enter callee ID')),
    );
    return;
  }
```

**Validation:**
- ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å callee ID ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‚Üí ‡πÅ‡∏™‡∏î‡∏á error message

---

```dart
  final callId = const Uuid().v4();
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á Call ID:**
```
Uuid().v4() = "11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5"
```
- Format: UUID version 4 (random)
- Unique globally

---

```dart
  final call = StreamService.client.makeCall(
    callType: StreamCallType.defaultType(),
    id: callId,
  );
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á Call object:**

**`makeCall()` ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
- ‡∏™‡∏£‡πâ‡∏≤‡∏á local `Call` instance
- **‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô server**
- ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° call configuration

**Parameters:**
- **`callType`**: `StreamCallType.defaultType()` ‚Üí `"default"`
- **`id`**: `"11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5"`

**Return:**
```dart
Call(
  id: '11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5',
  type: 'default',
  client: StreamVideo(...),
  // state, methods
)
```

---

```dart
  await call.getOrCreate(
    memberIds: [calleeId],
    ringing: true,
  );
```

**‡∏™‡∏£‡πâ‡∏≤‡∏á call ‡πÉ‡∏ô Stream Backend:**

### HTTP Request:

```http
POST https://video.stream-io-api.com/api/v2/video/call/default/11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5
Authorization: eyJhbGc... (User A Token)
Stream-Auth-Type: jwt
Content-Type: application/json

{
  "members": [
    {"user_id": "user-a"},
    {"user_id": "user-b"}
  ],
  "ring": true,
  "data": {
    "created_by_id": "user-a"
  }
}
```

**Query Parameters:**
- **Path:** `call/default/11d3e2b5-...`
  - `default` = call type
  - `11d3e2b5-...` = call ID

**Body:**
- **`members`**: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ user IDs
  - Auto add creator (user-a)
  - ‡πÄ‡∏û‡∏¥‡πà‡∏° calleeId (user-b)
- **`ring: true`**: ‚úÖ **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!** ‚Üí ‡∏™‡πà‡∏á push notification

---

### Stream Backend ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:

**1. Validate:**
- ‡πÄ‡∏ä‡πá‡∏Ñ JWT token
- ‡πÄ‡∏ä‡πá‡∏Ñ user ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á call ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- ‡πÄ‡∏ä‡πá‡∏Ñ members ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á

**2. Create Call:**
```sql
-- Pseudo-code
INSERT INTO calls (
  id, type, created_by, created_at, status
) VALUES (
  '11d3e2b5-...', 'default', 'user-a', NOW(), 'ringing'
);

INSERT INTO call_members (call_id, user_id, role) VALUES
  ('11d3e2b5-...', 'user-a', 'admin'),
  ('11d3e2b5-...', 'user-b', 'user');
```

**3. Response:**
```json
{
  "call": {
    "id": "11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5",
    "type": "default",
    "cid": "default:11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5",
    "created_by": {
      "id": "user-a",
      "name": "Alice"
    },
    "created_at": "2025-02-07T10:35:00.000Z",
    "status": "ringing"
  },
  "members": [
    {"user_id": "user-a", "role": "admin"},
    {"user_id": "user-b", "role": "user"}
  ]
}
```

---

```dart
  await call.ring();
```

**‡∏™‡πà‡∏á ring signal:**

### HTTP Request:

```http
POST https://video.stream-io-api.com/api/v2/video/call/default/11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5/ring
Authorization: eyJhbGc...
Stream-Auth-Type: jwt

{"ring": true}
```

**Stream Backend:**
1. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï call status ‚Üí `ringing`
2. Trigger push notification workflow
3. Set ringing timeout (default: 45 seconds)

---

```dart
  print('‚úÖ Call ring notification sent');

  if (mounted) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) => CallPage(call: call, isOutgoing: true),
      ),
    );
  }
```

**‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ CallPage:**
- User A ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "Calling user-b..."
- ‡∏£‡∏≠ User B ‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢

---

# STEP 13: Stream ‡∏™‡πà‡∏á Push Notification

## Stream Backend Workflow:

### 13.1 Query User B Devices

```sql
-- Pseudo-code
SELECT * FROM devices
WHERE user_id = 'user-b'
AND push_provider_name = 'niwner_notification';
```

**Result:**
```json
{
  "devices": [
    {
      "id": "dFp8HxN-QkG7RzVQX-fPQW:APA91bF...",
      "push_provider": "firebase",
      "push_provider_name": "niwner_notification",
      "platform": "android",
      "user_id": "user-b"
    }
  ]
}
```

**‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠:**
- User B ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ login
- FCM token ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ register
- **‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á notification (User B ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢)

---

### 13.2 Get Push Provider Configuration

```sql
-- Pseudo-code
SELECT * FROM push_providers
WHERE name = 'niwner_notification';
```

**Result:**
```json
{
  "name": "niwner_notification",
  "type": "firebase",
  "fcm_server_key": "AAAA...[Server Key from Dashboard]",
  "status": "active"
}
```

**‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ status != active:**
- Push provider ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ config
- **‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:** ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á notification

---

### 13.3 ‡∏™‡∏£‡πâ‡∏≤‡∏á Notification Payload

```json
{
  "to": "dFp8HxN-QkG7RzVQX-fPQW:APA91bF...",
  "priority": "high",
  "data": {
    "stream_call_cid": "default:11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5",
    "stream_call_id": "11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5",
    "stream_call_type": "default",
    "call_type": "call.ring",
    "created_by_id": "user-a",
    "created_by_name": "Alice",
    "receiver_id": "user-b",
    "sender": "stream_video"
  },
  "android": {
    "priority": "high",
    "ttl": "45s"
  },
  "apns": {
    "headers": {
      "apns-priority": "10",
      "apns-expiration": "45"
    },
    "payload": {
      "aps": {
        "alert": {
          "title": "Incoming Call",
          "body": "Alice is calling..."
        },
        "sound": "default",
        "category": "call"
      }
    }
  }
}
```

---

### 13.4 ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Firebase FCM

```http
POST https://fcm.googleapis.com/fcm/send
Authorization: key=AAAA[FCM_SERVER_KEY]
Content-Type: application/json

{
  "to": "dFp8HxN-QkG7RzVQX-fPQW:APA91bF...",
  "priority": "high",
  "data": { ... }
}
```

**Firebase Response:**
```json
{
  "multicast_id": 1234567890123456789,
  "success": 1,
  "failure": 0,
  "results": [
    {
      "message_id": "0:1234567890123456%abc123"
    }
  ]
}
```

**`success: 1`:**
- ‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
- Firebase ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á User B device

**`failure: 1`:**
- FCM Token invalid/expired
- Device offline ‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
- User uninstalled app

---

# STEP 14: User B ‡∏£‡∏±‡∏ö Notification

## ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: User B ‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà (Foreground)

### ‡πÑ‡∏ü‡∏•‡πå: `lib/pages/home_page.dart`

```dart
@override
void initState() {
  super.initState();
  FirebaseMessaging.onMessage.listen(_handleRemoteMessage);
}

void _handleRemoteMessage(RemoteMessage message) {
  debugPrint('üîî FCM MESSAGE RECEIVED (FOREGROUND)');
  debugPrint('Data: ${message.data}');
}
```

**`FirebaseMessaging.onMessage`:**
- Stream ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö foreground messages
- Emit `RemoteMessage` ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ notification

**`RemoteMessage` object:**
```dart
RemoteMessage(
  messageId: '0:1234567890123456%abc123',
  data: {
    'stream_call_cid': 'default:11d3e2b5-...',
    'stream_call_id': '11d3e2b5-...',
    'call_type': 'call.ring',
    'created_by_name': 'Alice',
    ...
  },
  notification: null,  // Data message (no notification)
)
```

---

### Stream SDK Handle Message Automatically:

**Stream SDK ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
1. Detect message ‡πÄ‡∏õ‡πá‡∏ô Stream Video notification
2. Parse `stream_call_cid`, `call_type`
3. Query call details ‡∏à‡∏≤‡∏Å Stream API
4. ‡∏™‡∏£‡πâ‡∏≤‡∏á `Call` object
5. **‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï `incomingCall` stream**

```dart
// Stream SDK internal:
StreamVideo.instance.state.incomingCall.value = Call(...);
```

---

### Listener ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:

```dart
void _observeIncomingCalls() {
  StreamService.client.state.incomingCall.listen((call) {
    // ‚Üê Listener ‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!
    if (call != null && mounted) {
      print('üìû Incoming call from: ${call.state.value.createdBy?.name}');
      // ‚Üí "üìû Incoming call from: Alice"

      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (_) => CallPage(call: call, isOutgoing: false),
        ),
      );
    }
  });
}
```

**Flow:**
```
FCM Message
    ‚Üì
Stream SDK parse
    ‚Üì
Query call details
    ‚Üì
Update incomingCall stream
    ‚Üì
Listener triggered
    ‚Üì
Open CallPage
```

**User B ‡πÄ‡∏´‡πá‡∏ô:**
- ‡∏´‡∏ô‡πâ‡∏≤ CallPage ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- ‡πÅ‡∏™‡∏î‡∏á "Alice is calling..."
- ‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏° Accept (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) ‡πÅ‡∏•‡∏∞ Reject (‡πÅ‡∏î‡∏á)

---

## ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: User B ‡πÅ‡∏≠‡∏õ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á (Background/Terminated)

### ‡πÑ‡∏ü‡∏•‡πå: `lib/firebase_background_handler.dart`

```dart
@pragma('vm:entry-point')
Future<void> firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  print('üîî BACKGROUND FCM MESSAGE RECEIVED');
  print('Data: ${message.data}');

  await StreamVideoPushNotificationManager.onBackgroundMessage(message);
}
```

**`@pragma('vm:entry-point')`:**
- ‡∏ö‡∏≠‡∏Å compiler ‡∏ß‡πà‡∏≤ function ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å native
- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ï‡∏≠‡∏ô tree-shaking

**`Firebase.initializeApp()`:**
- ‡∏ï‡πâ‡∏≠‡∏á init ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏£‡∏≤‡∏∞ background handler ‡∏£‡∏±‡∏ô‡πÉ‡∏ô isolate ‡πÅ‡∏¢‡∏Å
- Isolate ‡πÑ‡∏°‡πà share state ‡∏Å‡∏±‡∏ö main isolate

---

### `StreamVideoPushNotificationManager.onBackgroundMessage()`:

**‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**

1. **Parse message:**
   ```dart
   final callCid = message.data['stream_call_cid'];
   // "default:11d3e2b5-..."
   ```

2. **Query call details:**
   ```http
   GET https://video.stream-io-api.com/api/v2/video/call/default/11d3e2b5-...
   Authorization: [User B Token]
   ```

3. **‡πÅ‡∏™‡∏î‡∏á Native Call UI:**

   **Android (ConnectionService):**
   ```kotlin
   // Stream SDK ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Android Telecom API
   val handle = PhoneAccountHandle(...)
   val extras = Bundle().apply {
       putString("caller_name", "Alice")
       putString("call_id", "11d3e2b5-...")
   }
   telecomManager.addNewIncomingCall(handle, extras)
   ```

   **iOS (CallKit):**
   ```swift
   // Stream SDK ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å iOS CallKit API
   let update = CXCallUpdate()
   update.localizedCallerName = "Alice"
   update.hasVideo = true

   provider.reportNewIncomingCall(with: uuid, update: update) { error in
       // Show native call UI
   }
   ```

**User B ‡πÄ‡∏´‡πá‡∏ô:**

**Android:**
- Full-screen incoming call UI (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏õ‡∏Å‡∏ï‡∏¥)
- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ "Alice"
- ‡∏õ‡∏∏‡πà‡∏° Accept (‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) ‡πÅ‡∏•‡∏∞ Decline (‡πÅ‡∏î‡∏á)

**iOS:**
- CallKit UI (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå iOS)
- ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠ "Alice"
- Slide to answer

---

# STEP 15: User B ‡∏Å‡∏î Accept

## ‡πÑ‡∏ü‡∏•‡πå: `lib/pages/call_page.dart`

### User B ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ CallPage:

```dart
class _CallPageState extends State<CallPage> {
  bool _isCallActive = false;

  @override
  void initState() {
    super.initState();
    if (widget.isOutgoing) {
      _waitForAccept();
    } else {
      _showIncomingCallUI();  // ‚Üê User B (callee)
    }
  }
```

**`widget.isOutgoing`:**
- `true` = User A (caller)
- `false` = User B (callee)

---

### UI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Incoming Call:

```dart
Widget build(BuildContext context) {
  if (!_isCallActive && !widget.isOutgoing) {
    // Incoming call UI
    return Scaffold(
      backgroundColor: Colors.black,
      body: Center(
        child: Column(
          children: [
            Icon(Icons.person, size: 100, color: Colors.white),
            Text(
              widget.call.state.value.createdBy?.name ?? 'Unknown',
              // ‚Üí "Alice"
              style: TextStyle(fontSize: 32, color: Colors.white),
            ),
            Text(
              'Incoming Call...',
              style: TextStyle(fontSize: 18, color: Colors.white70),
            ),
            Row(
              children: [
                FloatingActionButton(
                  onPressed: _rejectCall,
                  backgroundColor: Colors.red,
                  child: Icon(Icons.call_end),
                ),
                FloatingActionButton(
                  onPressed: _acceptCall,  // ‚Üê ‡∏Å‡∏î Accept
                  backgroundColor: Colors.green,
                  child: Icon(Icons.call),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
  // ...
}
```

**User B ‡πÄ‡∏´‡πá‡∏ô:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                              ‚îÇ
‚îÇ       üë§                     ‚îÇ
‚îÇ                              ‚îÇ
‚îÇ      Alice                   ‚îÇ
‚îÇ                              ‚îÇ
‚îÇ   Incoming Call...           ‚îÇ
‚îÇ                              ‚îÇ
‚îÇ                              ‚îÇ
‚îÇ  [üî¥ Reject]   [üü¢ Accept]  ‚îÇ
‚îÇ                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### User B ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Accept:

```dart
Future<void> _acceptCall() async {
  try {
    print('‚úÖ Accepting call...');
    await widget.call.accept();
    setState(() => _isCallActive = true);
    print('‚úÖ Call accepted');
  } catch (e) {
    print('‚ùå Failed to accept: $e');
  }
}
```

---

### `call.accept()` ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:

**1. ‡∏™‡πà‡∏á HTTP Request:**
```http
POST https://video.stream-io-api.com/api/v2/video/call/default/11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5/accept
Authorization: [User B Token]
Stream-Auth-Type: jwt
Content-Type: application/json

{}
```

**2. Stream Backend ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï:**
```
Call Status: ringing ‚Üí active
Members: user-a (joined), user-b (joined)
```

**3. Notify User A:**
```
WebSocket Event ‚Üí User A
{
  "type": "call.accepted",
  "call_cid": "default:11d3e2b5-...",
  "user": {
    "id": "user-b",
    "name": "Bob"
  }
}
```

**User A ‡πÄ‡∏´‡πá‡∏ô:**
- Status ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å "Ringing..." ‚Üí "Connecting..."

---

# STEP 16: WebRTC Connection Setup

## 16.1 User A ‡∏™‡∏£‡πâ‡∏≤‡∏á Offer

**‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
- ‡∏™‡∏£‡πâ‡∏≤‡∏á SDP (Session Description Protocol) Offer
- ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• codecs, network info

**Code (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Stream SDK):**
```dart
// User A
final offer = await peerConnection.createOffer();
await peerConnection.setLocalDescription(offer);
```

**SDP Offer (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á):**
```
v=0
o=- 1234567890 2 IN IP4 127.0.0.1
s=-
t=0 0
a=group:BUNDLE 0 1
m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104
a=rtpmap:111 opus/48000/2
a=rtpmap:103 ISAC/16000
m=video 9 UDP/TLS/RTP/SAVPF 96 97
a=rtpmap:96 VP8/90000
a=rtpmap:97 H264/90000
```

---

### ‡∏™‡πà‡∏á Offer ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Stream Backend:

```http
POST https://video.stream-io-api.com/api/v2/video/call/default/11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5/sdp/offer
Authorization: [User A Token]

{
  "sdp": "v=0\no=- 1234567890...",
  "type": "offer"
}
```

---

### Stream Backend Forward to User B:

```
WebSocket ‚Üí User B
{
  "type": "sdp.offer",
  "call_cid": "default:11d3e2b5-...",
  "sdp": "v=0\no=- 1234567890..."
}
```

---

## 16.2 User B ‡∏™‡∏£‡πâ‡∏≤‡∏á Answer

**Code (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Stream SDK):**
```dart
// User B
await peerConnection.setRemoteDescription(offer);
final answer = await peerConnection.createAnswer();
await peerConnection.setLocalDescription(answer);
```

**SDP Answer:**
```
v=0
o=- 9876543210 2 IN IP4 127.0.0.1
s=-
t=0 0
m=audio 9 UDP/TLS/RTP/SAVPF 111
a=rtpmap:111 opus/48000/2
m=video 9 UDP/TLS/RTP/SAVPF 96
a=rtpmap:96 VP8/90000
```

---

### ‡∏™‡πà‡∏á Answer ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á User A:

```http
POST https://video.stream-io-api.com/api/v2/video/call/.../sdp/answer
Authorization: [User B Token]

{
  "sdp": "v=0\no=- 9876543210...",
  "type": "answer"
}
```

```
Stream Backend ‚Üí User A (WebSocket)
{
  "type": "sdp.answer",
  "sdp": "v=0\no=- 9876543210..."
}
```

**User A:**
```dart
await peerConnection.setRemoteDescription(answer);
```

---

## 16.3 ICE Candidate Exchange

**‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
- ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô network paths (IP addresses, ports)
- ‡∏´‡∏≤ route ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö P2P connection

**ICE Candidate (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á):**
```
candidate:1 1 UDP 2130706431 192.168.1.100 54321 typ host
candidate:2 1 UDP 1694498815 203.0.113.50 12345 typ srflx raddr 192.168.1.100 rport 54321
```

**Types:**
- **host**: Local IP
- **srflx**: Server Reflexive (public IP, via STUN)
- **relay**: Relayed (via TURN server)

---

**User A ‚Üí Stream ‚Üí User B:**
```http
POST https://video.stream-io-api.com/api/v2/video/call/.../ice
{
  "candidate": "candidate:1 1 UDP 2130706431...",
  "sdpMid": "0",
  "sdpMLineIndex": 0
}
```

**User B ‚Üí Stream ‚Üí User A:**
```http
POST https://video.stream-io-api.com/api/v2/video/call/.../ice
{
  "candidate": "candidate:2 1 UDP 1694498815...",
  ...
}
```

---

## 16.4 Connection Established

**‡πÄ‡∏°‡∏∑‡πà‡∏≠ ICE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:**
```dart
peerConnection.onIceConnectionState = (state) {
  if (state == RTCIceConnectionState.connected) {
    print('‚úÖ WebRTC connected!');
  }
};
```

**Connection Path:**
```
User A Device
    ‚Üì (Direct P2P if possible)
User B Device

Or via TURN:
User A ‚Üí TURN Server ‚Üí User B
```

---

# STEP 17: Active Call - Video/Audio Streaming

## UI ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Active Call:

```dart
Widget build(BuildContext context) {
  // ...
  if (_isCallActive) {
    return Scaffold(
      body: StreamCallContainer(
        call: widget.call,
        callContentBuilder: (context, call, callState) {
          return StreamCallContent(
            call: call,
            callState: callState,
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _endCall,
        backgroundColor: Colors.red,
        child: Icon(Icons.call_end),
      ),
    );
  }
}
```

---

### `StreamCallContainer`:

**‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:**
1. Setup video renderers
2. Handle media streams
3. Render participant videos
4. Provide call controls

**`StreamCallContent`:**
- Pre-built UI components:
  - Video tiles
  - Audio indicators
  - Network quality
  - Participant list
  - Mute/unmute buttons
  - Camera on/off
  - Speaker/earpiece toggle

---

### Media Streams:

**Audio:**
```dart
// User A microphone ‚Üí encode ‚Üí send to User B
// User B receive ‚Üí decode ‚Üí play on speaker
```

**Video:**
```dart
// User A camera ‚Üí encode (VP8/H264) ‚Üí send to User B
// User B receive ‚Üí decode ‚Üí render on screen
```

**Real-time:**
- Latency: ~100-300ms
- Bitrate: 500kbps-2Mbps (adaptive)
- Resolution: 320x240 ‚Üí 1280x720 (adaptive)

---

### Call State:

```dart
call.state.listen((callState) {
  print('Status: ${callState.status}');
  print('Participants: ${callState.participants.length}');
  print('Duration: ${callState.duration}');
});
```

**CallState object:**
```dart
CallState(
  status: CallStatus.active,
  participants: [
    CallParticipant(
      userId: 'user-a',
      name: 'Alice',
      isLocalParticipant: true,
      isSpeaking: true,
      videoEnabled: true,
      audioEnabled: true,
    ),
    CallParticipant(
      userId: 'user-b',
      name: 'Bob',
      isLocalParticipant: false,
      isSpeaking: false,
      videoEnabled: true,
      audioEnabled: true,
    ),
  ],
  duration: Duration(seconds: 120),
)
```

---

# STEP 18: End Call

## User ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "End Call":

```dart
Future<void> _endCall() async {
  try {
    print('üì¥ Ending call...');
    await widget.call.leave();
    if (mounted) Navigator.pop(context);
  } catch (e) {
    print('‚ùå Failed to end call: $e');
  }
}
```

---

### `call.leave()` ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£:

**1. ‡∏™‡πà‡∏á HTTP Request:**
```http
POST https://video.stream-io-api.com/api/v2/video/call/default/11d3e2b5-19c4-4f1c-bd42-f0ea8d8ba9f5/leave
Authorization: [User Token]
```

**2. Disconnect WebRTC:**
```dart
// Stop media tracks
audioTrack.stop();
videoTrack.stop();

// Close peer connection
peerConnection.close();
```

**3. Update Call State:**
```
User A: left
User B: still in call (‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà leave)
```

**4. Notify Other Participants:**
```
WebSocket ‚Üí User B
{
  "type": "call.member_left",
  "user": {"id": "user-a", "name": "Alice"}
}
```

---

### User B ‡∏£‡∏±‡∏ö event:

```dart
call.state.listen((state) {
  if (state.status == CallStatus.ended) {
    // User B ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤ call ended
    Navigator.pop(context);
  }
});
```

**User B ‡πÄ‡∏´‡πá‡∏ô:**
- Video ‡∏´‡∏≤‡∏¢
- ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ HomePage
- Toast/Snackbar: "Call ended"

---

### ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ End Call ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô:

```dart
await call.leave(endCall: true);
```

**‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á:**
- **`leave()`**: ‡∏≠‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
- **`leave(endCall: true)`**: end call ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å)

---

# ‡∏™‡∏£‡∏∏‡∏õ Flow ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

```
1. ‡πÄ‡∏õ‡∏¥‡∏î App
   main() ‚Üí Initialize Firebase ‚Üí Register Background Handler ‚Üí Request Permission
   ‚Üì
2. ‡πÅ‡∏™‡∏î‡∏á LoginPage
   User ‡∏Å‡∏£‡∏≠‡∏Å ID/Name ‚Üí ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Login
   ‚Üì
3. ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Backend
   POST /v1/api/callStreams ‚Üí Backend generate JWT token
   ‚Üì
4. Initialize StreamVideo
   StreamVideo() ‚Üí connect() ‚Üí Register FCM Token
   ‚Üì
5. Navigate HomePage
   Listen for Incoming Calls
   ‚Üì
6. User A ‡πÇ‡∏ó‡∏£ User B
   makeCall() ‚Üí getOrCreate(ringing: true) ‚Üí ring()
   ‚Üì
7. Stream Backend
   Query User B devices ‚Üí Get FCM token ‚Üí Send to Firebase
   ‚Üì
8. Firebase ‚Üí User B Device
   Foreground: onMessage ‚Üí IncomingCall stream ‚Üí CallPage
   Background: onBackgroundMessage ‚Üí CallKit/ConnectionService
   ‚Üì
9. User B Accept
   call.accept() ‚Üí Notify User A ‚Üí Start WebRTC
   ‚Üì
10. WebRTC Setup
    Offer/Answer SDP ‚Üí ICE Candidates ‚Üí Connection Established
    ‚Üì
11. Active Call
    Audio/Video streaming ‚Üí Real-time communication
    ‚Üì
12. End Call
    call.leave() ‚Üí Disconnect WebRTC ‚Üí Navigate back ‚Üí HomePage
```

---

# ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Components

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Flutter App                                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  main.dart                                                    ‚îÇ
‚îÇ    ‚îî‚îÄ Firebase.initializeApp()                              ‚îÇ
‚îÇ    ‚îî‚îÄ runApp(MyApp)                                          ‚îÇ
‚îÇ         ‚îî‚îÄ LoginPage                                         ‚îÇ
‚îÇ              ‚îî‚îÄ Call Backend API                             ‚îÇ
‚îÇ              ‚îî‚îÄ StreamService.initialize()                   ‚îÇ
‚îÇ                   ‚îî‚îÄ StreamVideo()                           ‚îÇ
‚îÇ                        ‚îî‚îÄ connect()                          ‚îÇ
‚îÇ                             ‚îî‚îÄ Register FCM Token            ‚îÇ
‚îÇ                   ‚îî‚îÄ HomePage                                ‚îÇ
‚îÇ                        ‚îî‚îÄ Listen incomingCall                ‚îÇ
‚îÇ                        ‚îî‚îÄ makeCall() ‚Üí getOrCreate() ‚Üí ring()‚îÇ
‚îÇ                             ‚îî‚îÄ CallPage                      ‚îÇ
‚îÇ                                  ‚îî‚îÄ accept()/reject()        ‚îÇ
‚îÇ                                  ‚îî‚îÄ StreamCallContainer      ‚îÇ
‚îÇ                                       ‚îî‚îÄ WebRTC Streaming    ‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üï                    ‚Üï                    ‚Üï
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Backend         ‚îÇ  ‚îÇ Stream Backend  ‚îÇ  ‚îÇ Firebase FCM   ‚îÇ
‚îÇ (Token Server)  ‚îÇ  ‚îÇ (Video/Audio)   ‚îÇ  ‚îÇ (Push Notify)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

**‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏¥‡∏î app (`main()`) ‡πÑ‡∏õ‡∏à‡∏ô‡∏à‡∏ö call ‡πÅ‡∏ö‡∏ö step-by-step üéâ**
